---
name: Music Analytics Project CI

on:
  push:
  schedule:
    - cron: "0 6 * * 1"
  workflow_dispatch:

env:
  NETLIFY_NAME: "stage-mla"
  PROJECT_NAME: "mla"
  INTEGRATION_TEST_LAST_FM_KEY: ${{ secrets.INTEGRATION_TEST_LAST_FM_KEY }}
  NETLIFY_TOKEN: ${{ secrets.NETLIFY_TOKEN }}

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v1

      - name: Build -- Setup Environment
        run: |
          source .github/scripts/setup.sh
        env:
          WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}

      - name: Build -- Install Node Modules
        run: |
          npm install

      - name: Build -- Append AWS Environment Content
        run: |
          echo "LASTFM_CACHE_AWS_ACCESS_KEY_ID=\"${LASTFM_CACHE_AWS_ACCESS_KEY_ID}\"" >> .env.test
          echo "LASTFM_CACHE_AWS_SECRET_ACCESS_KEY=\"${LASTFM_CACHE_AWS_SECRET_ACCESS_KEY}\"" >> .env.test
          echo "LASTFM_CACHE_AWS_REGION=\"${LASTFM_CACHE_AWS_REGION}\"" >> .env.test
          echo "LASTFM_CACHE_AWS_S3_BUCKET_NAME=\"${LASTFM_CACHE_AWS_S3_BUCKET_NAME}\"" >> .env.test
          echo "LASTFM_CACHE_AWS_CLOUDFRONT_DOMAIN_NAME=\"${LASTFM_CACHE_AWS_CLOUDFRONT_DOMAIN_NAME}\"" >> .env.test
        env:
          LASTFM_CACHE_AWS_ACCESS_KEY_ID: ${{ secrets.LASTFM_CACHE_AWS_ACCESS_KEY_ID }}
          LASTFM_CACHE_AWS_SECRET_ACCESS_KEY: ${{ secrets.LASTFM_CACHE_AWS_SECRET_ACCESS_KEY }}
          LASTFM_CACHE_AWS_REGION: ${{ secrets.LASTFM_CACHE_AWS_REGION }}
          LASTFM_CACHE_AWS_S3_BUCKET_NAME: ${{ secrets.LASTFM_CACHE_AWS_S3_BUCKET_NAME }}
          LASTFM_CACHE_AWS_CLOUDFRONT_DOMAIN_NAME: ${{ secrets.LASTFM_CACHE_AWS_CLOUDFRONT_DOMAIN_NAME }}

      - name: Build -- Unit Tests and Coverage
        run: |
          npm run coverage

      - name: Build -- Report Job Status
        if: ${{ failure() }}
        run: |
          ./.github/scripts/notifications.sh "${NOTIFICATION}" ":x: error during build!"

  deploy_stage:
    needs: [success_notification]

    runs-on: ubuntu-latest

    steps:
      - name: Deploy Stage -- Checkout Repository
        if: github.ref == 'refs/heads/master'
        uses: actions/checkout@v1

      - name: Deploy Stage -- Setup Environment
        if: github.ref == 'refs/heads/master'
        run: |
          source ./.github/scripts/setup.sh
        env:
          WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}

      - name: Build -- Append AWS Environment Content
        run: |
          echo "LASTFM_CACHE_AWS_ACCESS_KEY_ID=\"${LASTFM_CACHE_AWS_ACCESS_KEY_ID}\"" >> .env.test
          echo "LASTFM_CACHE_AWS_SECRET_ACCESS_KEY=\"${LASTFM_CACHE_AWS_SECRET_ACCESS_KEY}\"" >> .env.test
          echo "LASTFM_CACHE_AWS_REGION=\"${LASTFM_CACHE_AWS_REGION}\"" >> .env.test
          echo "LASTFM_CACHE_AWS_S3_BUCKET_NAME=\"${LASTFM_CACHE_AWS_S3_BUCKET_NAME}\"" >> .env.test
          echo "LASTFM_CACHE_AWS_CLOUDFRONT_DOMAIN_NAME=\"${LASTFM_CACHE_AWS_CLOUDFRONT_DOMAIN_NAME}\"" >> .env.test
        env:
          LASTFM_CACHE_AWS_ACCESS_KEY_ID: ${{ secrets.LASTFM_CACHE_AWS_ACCESS_KEY_ID }}
          LASTFM_CACHE_AWS_SECRET_ACCESS_KEY: ${{ secrets.LASTFM_CACHE_AWS_SECRET_ACCESS_KEY }}
          LASTFM_CACHE_AWS_REGION: ${{ secrets.LASTFM_CACHE_AWS_REGION }}
          LASTFM_CACHE_AWS_S3_BUCKET_NAME: ${{ secrets.LASTFM_CACHE_AWS_S3_BUCKET_NAME }}
          LASTFM_CACHE_AWS_CLOUDFRONT_DOMAIN_NAME: ${{ secrets.LASTFM_CACHE_AWS_CLOUDFRONT_DOMAIN_NAME }}

      - name: Deploy Stage -- Trigger Netlify API
        if: github.ref == 'refs/heads/master'
        run: |
          sudo npm install netlify-cli -g
          npm install
          netlify deploy --build --prod -s ${NETLIFY_SITE_ID}
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

      - name: Deploy Stage -- Report Job Status on Success
        if: github.ref == 'refs/heads/master'
        run: |
          ./.github/scripts/notifications.sh "${NOTIFICATION}" ":white_check_mark: deployed https://${NETLIFY_NAME}.netlify.app"

      - name: Deploy Stage -- Report Job Status on Failure
        if: failure()
        run: |
          ./.github/scripts/notifications.sh "${NOTIFICATION}" ":x: error deploying branch!"

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v1

      - name: Lint -- Setup Environment
        run: |
          source .github/scripts/setup.sh
        env:
          WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}

      - name: Lint -- Install Node Modules
        run: |
          npm install

      - name: Lint -- Run Linter
        run: |
          npm run lint

      - name: Lint -- Report Job Status
        if: ${{ failure() }}
        run: |
          ./.github/scripts/notifications.sh "${NOTIFICATION}" ":x: lint check has failed!"

  security_test:
    runs-on: ubuntu-latest

    steps:
      - name: Security Test -- Checkout Repository
        uses: actions/checkout@v1

      - name: Documentation Test -- Setup Environment
        run: |
          source .github/scripts/setup.sh
        env:
          WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}

      - name: Security Test -- Install Node Modules
        run: |
          npm install

      - name: Security Test -- Dependency Audit
        run: |
          npm run security

      - name: Security Test -- Run Gitleaks
        uses: zricethezav/gitleaks-action@v1.6.0

      - name: Security Test -- Report Failure
        if: failure()
        run: |
          ./.github/scripts/notifications.sh "${NOTIFICATION}" ":x: security checks failed!"

  shellcheck_test:
    runs-on: ubuntu-latest

    steps:
      - name: Shellcheck -- Checkout Repository
        uses: actions/checkout@v1

      - name: Shellcheck -- Setup Environment
        run: |
          source .github/scripts/setup.sh
        env:
          WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}

      - name: Shellcheck -- Check Scripts
        run: |
          shellcheck .github/scripts/*.sh

      - name: Shellcheck -- Report Job Status on Failure
        if: failure()
        run: |
          ./.github/scripts/notifications.sh "${NOTIFICATION}" ":x: shellcheck checks failed!"

  start_notification:
    runs-on: ubuntu-latest

    steps:
      - name: Start -- Checkout Repository
        uses: actions/checkout@v1

      - name: Start -- Setup Environment
        run: |
          source ./.github/scripts/setup.sh
        env:
          WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}

      - name: Start -- Report Job Status on Success
        run: |
          ./.github/scripts/notifications.sh "${NOTIFICATION}" ":white_check_mark: workflow has started!"

      - name: Start -- Report Job Status on Failure
        if: failure()
        run: |
          ./.github/scripts/notifications.sh "${NOTIFICATION}" ":x: error reporting job status!"

  type_validation:
    runs-on: ubuntu-latest

    steps:
      - name: Type Validation -- Checkout Repository
        uses: actions/checkout@v1

      - name: Type Validation -- Setup Environment
        run: |
          source ./.github/scripts/setup.sh
        env:
          WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}

      - name: Type Validation -- Install Node Modules
        run: |
          npm install

      - name: Type Validation -- Compile Typescript
        run: |
          npm run compile

      - name: Type Validation -- Report Job Status on Failure
        if: failure()
        run: |
          ./.github/scripts/notifications.sh "${NOTIFICATION}" ":x: type validation failed!"

  success_notification:
    needs:
      [
        build,
        lint,
        security_test,
        shellcheck_test,
        start_notification,
        type_validation,
        workflow_lint_test,
      ]

    runs-on: ubuntu-latest

    steps:
      - name: Success -- Checkout Repository
        uses: actions/checkout@v1

      - name: Success -- Setup Environment
        run: |
          source .github/scripts/setup.sh
        env:
          WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}

      - name: Success -- Report Job Status on Success
        run: |
          ./.github/scripts/notifications.sh "${NOTIFICATION}" ":white_check_mark: all checks were successful!"

      - name: Success -- Report Job Status on Failure
        if: failure()
        run: |
          ./.github/scripts/notifications.sh "${NOTIFICATION}" ":x: error reporting job status!"

  workflow_lint_test:
    runs-on: ubuntu-latest
    strategy:
      max-parallel: 4
      matrix:
        python-version: [3.8]

    steps:
      - name: Workflow Lint -- Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v1
        with:
          python-version: ${{ matrix.python-version }}

      - name: Workflow Lint -- Checkout Repository
        uses: actions/checkout@v1

      - name: Workflow Lint -- Setup Environment
        run: |
          source ./.github/scripts/setup.sh
          pip install yamllint
        env:
          WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}

      - name: Workflow Lint -- Run Linter
        run: |
          yamllint ./.github/workflows -c .yamllint.yml -f standard

      - name: Workflow Lint -- Report Job Status on Failure
        if: failure()
        run: |
          ./.github/scripts/notifications.sh "${NOTIFICATION}" ":x: workflow linting has failed!"
